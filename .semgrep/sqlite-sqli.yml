rules:
  - id: python.sqlite.sql-injection.string-built-query
    message: "Possible SQL injection: SQL query appears to be built via string formatting/concatenation and then executed. Use parameterized queries."
    severity: WARNING
    languages: [python]
    metadata:
      category: security
      technology: [sqlite]
      cwe: ["CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')"]
    pattern-either:
      # String concatenation (dataset case 1/2/5/7/8/9/10/11 style)
      - patterns:
          - pattern: $CUR.execute($Q)
          - pattern-inside: |
              $Q = $A + $B
              ...
              $CUR.execute($Q)

      # f-string formatting (dataset case 3/4 style)
      - patterns:
          - pattern: $CUR.execute($Q)
          - pattern-inside: |
              $Q = f"...{$X}..."
              ...
              $CUR.execute($Q)

      # .format() formatting
      - patterns:
          - pattern: $CUR.execute($Q)
          - pattern-inside: |
              $Q = "...".format(...)
              ...
              $CUR.execute($Q)

      # %-formatting
      - patterns:
          - pattern: $CUR.execute($Q)
          - pattern-inside: |
              $Q = "..." % ...
              ...
              $CUR.execute($Q)

  - id: python.sql.suspicious.constant-query-patterns
    message: "Suspicious SQL pattern in a constant query string (may indicate time-based/error-based injection payloads or malicious query logic). Review carefully."
    severity: INFO
    languages: [python]
    metadata:
      category: security
      confidence: MEDIUM
      cwe:
        - "CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')"
        - "CWE-400: Uncontrolled Resource Consumption"
    pattern-either:
      # Time-based payload patterns commonly used for injection testing
      - pattern-regex: (?i)\bSLEEP\s*\(\s*\d+\s*\)
      - pattern-regex: (?i)\bBENCHMARK\s*\(
      - pattern-regex: (?i)\bWAITFOR\s+DELAY\b
      # Conditional time-delay patterns
      - pattern-regex: (?i)\bIF\s*\([^)]*SLEEP\s*\(\s*\d+\s*\)[^)]*\)
      - pattern-regex: (?i)\bCASE\b[\s\S]*\bSLEEP\s*\(
      # Error-based patterns (e.g., divide-by-zero used to trigger DB errors)
      - pattern-regex: (?i)\b1\s*/\s*0\b

